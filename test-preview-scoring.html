<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Preview Scoring Test</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            max-width: 800px;
            margin: 40px auto;
            padding: 20px;
            background: #faf9f7;
        }
        .test-case {
            background: white;
            border: 1px solid #e8e4de;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .test-title {
            font-weight: 600;
            margin-bottom: 10px;
            color: #2d2a26;
        }
        .result {
            font-size: 24px;
            color: #c9a962;
            margin: 10px 0;
        }
        .drivers {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }
        .chip {
            background: #f5f3ef;
            border: 1px solid #e8e4de;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 13px;
        }
        .notice {
            color: #6b6560;
            font-size: 13px;
            font-style: italic;
            margin-top: 8px;
        }
        pre {
            background: #f5f3ef;
            padding: 10px;
            border-radius: 4px;
            font-size: 12px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <h1>Preview.html Scoring Test Cases</h1>
    
    <div id="test-results"></div>

    <script>
        // Copy the exact scoring function from preview.html
        function computeUpgradeOdds(bookingData, contextData) {
            let score = -0.25; // Base score (baseline ~44%)
            const drivers = [];
            let hasMissingFields = false;

            // Extract and normalize data
            const channel = (bookingData.channel || bookingData.bookingChannel || '').toLowerCase();
            const lengthOfStay = contextData.lengthOfStay || '';
            const arrivalDay = (contextData.arrivalDay || '').toLowerCase();
            const loyalty = (contextData.loyalty || contextData.loyaltyStatus || '').toLowerCase();
            const occasion = (contextData.occasion || '').toLowerCase();
            const flexibility = (contextData.flexibility || '').toLowerCase();
            const askPreference = (contextData.askPreference || '').toLowerCase();

            // Channel scoring
            if (channel.includes('direct')) {
                score += 0.55;
                drivers.push('Direct booking');
            } else if (channel.includes('corporate') || channel.includes('negotiated')) {
                score += 0.40;
                drivers.push('Corporate rate');
            } else if (channel.includes('ota') || channel.includes('travel agency')) {
                score -= 0.55;
                drivers.push('OTA booking');
            } else if (channel) {
                // Unknown channel provided, neutral
            } else {
                hasMissingFields = true;
            }

            // Loyalty scoring
            if (loyalty.includes('gold') || loyalty.includes('top')) {
                score += 0.55;
                drivers.push('Top-tier loyalty');
            } else if (loyalty.includes('silver') || loyalty.includes('mid')) {
                score += 0.30;
                drivers.push('Mid-tier loyalty');
            } else if (loyalty.includes('member') && loyalty !== 'none') {
                score += 0.10;
                drivers.push('Member status');
            } else if (loyalty === 'none') {
                // No loyalty, no adjustment
            } else {
                hasMissingFields = true;
            }

            // Length of stay scoring
            if (lengthOfStay === '1' || lengthOfStay === '1 night') {
                score -= 0.10;
                drivers.push('1-night stay');
            } else if (lengthOfStay === '2' || lengthOfStay === '2 nights') {
                score += 0.05;
            } else if (lengthOfStay === '3-4' || lengthOfStay.includes('3') || lengthOfStay.includes('4')) {
                score += 0.10;
            } else if (lengthOfStay === '5+' || lengthOfStay.includes('5')) {
                score -= 0.05;
                drivers.push('Extended stay');
            } else if (lengthOfStay) {
                // Unknown format, neutral
            } else {
                hasMissingFields = true;
            }

            // Arrival day scoring (demand proxy)
            if (arrivalDay === 'friday') {
                score -= 0.25;
                drivers.push('Weekend arrival');
            } else if (arrivalDay === 'saturday') {
                score -= 0.35;
                drivers.push('Weekend arrival');
            } else if (arrivalDay === 'sunday') {
                score -= 0.10;
            } else if (arrivalDay === 'monday' || arrivalDay === 'tuesday' || arrivalDay === 'wednesday' || arrivalDay === 'thursday') {
                score += 0.05;
                drivers.push('Weekday arrival');
            } else if (arrivalDay) {
                // Unknown day, neutral
            } else {
                hasMissingFields = true;
            }

            // Ask preference scoring
            if (askPreference === 'both') {
                score += 0.20;
                drivers.push('Asking before arrival');
            } else if (askPreference === 'email') {
                score += 0.10;
                drivers.push('Email request');
            } else if (askPreference === 'inperson' || askPreference === 'in_person') {
                score += 0.05;
            } else if (askPreference) {
                // Unknown preference, neutral
            } else {
                hasMissingFields = true;
            }

            // Flexibility scoring
            if (flexibility === 'any') {
                score += 0.25;
                drivers.push('Flexible on room type');
            } else if (flexibility === 'specific') {
                score += 0.10;
            } else if (flexibility === 'no') {
                score -= 0.20;
            } else if (flexibility) {
                // Unknown value, neutral
            } else {
                hasMissingFields = true;
            }

            // Occasion scoring
            if (occasion.includes('anniversary') || occasion.includes('honeymoon')) {
                score += 0.20;
                drivers.push('Special occasion');
            } else if (occasion.includes('birthday') || occasion.includes('first visit') || (occasion && occasion !== 'none')) {
                score += 0.10;
                drivers.push('Special occasion');
            }

            // Convert score to probability using logistic function
            const prob = 1 / (1 + Math.exp(-score));
            let percentage = Math.round(prob * 100);

            // Clamp to 5-85% range
            percentage = Math.max(5, Math.min(85, percentage));

            return {
                percentage,
                drivers,
                hasMissingFields,
                rawScore: score
            };
        }

        // Test cases
        const testCases = [
            {
                name: "Test A: Direct + Gold + Weekday + Flexible + Both (Should be high)",
                booking: { channel: 'Direct with hotel' },
                context: {
                    loyalty: 'Gold / top-tier',
                    arrivalDay: 'Wednesday',
                    flexibility: 'any',
                    askPreference: 'both',
                    lengthOfStay: '3-4',
                    occasion: 'none'
                }
            },
            {
                name: "Test B: OTA + None + Saturday + No flexibility (Should be low)",
                booking: { channel: 'Online travel agency (OTA)' },
                context: {
                    loyalty: 'none',
                    arrivalDay: 'Saturday',
                    flexibility: 'no',
                    askPreference: 'inperson',
                    lengthOfStay: '1',
                    occasion: 'none'
                }
            },
            {
                name: "Test C: Missing loyalty/occasion (Should still work + show notice)",
                booking: { channel: 'Direct with hotel' },
                context: {
                    arrivalDay: 'Tuesday',
                    flexibility: 'any',
                    askPreference: 'both',
                    lengthOfStay: '2'
                }
            },
            {
                name: "Test D: Corporate + Anniversary + Email (Good odds)",
                booking: { channel: 'Corporate / negotiated rate' },
                context: {
                    loyalty: 'Silver / mid-tier',
                    arrivalDay: 'Monday',
                    flexibility: 'specific',
                    askPreference: 'email',
                    lengthOfStay: '3-4',
                    occasion: 'Anniversary'
                }
            },
            {
                name: "Test E: Baseline (minimal positive factors)",
                booking: { channel: 'Direct with hotel' },
                context: {
                    loyalty: 'none',
                    arrivalDay: 'Thursday',
                    flexibility: 'specific',
                    askPreference: 'email',
                    lengthOfStay: '2',
                    occasion: 'none'
                }
            }
        ];

        // Run tests and display results
        const resultsContainer = document.getElementById('test-results');
        testCases.forEach(test => {
            const result = computeUpgradeOdds(test.booking, test.context);
            
            const testDiv = document.createElement('div');
            testDiv.className = 'test-case';
            
            let html = `
                <div class="test-title">${test.name}</div>
                <div class="result">${result.percentage}%</div>
                <pre>Raw score: ${result.rawScore.toFixed(3)}</pre>
                <div class="drivers">
                    ${result.drivers.map(d => `<span class="chip">${d}</span>`).join('')}
                </div>
            `;
            
            if (result.hasMissingFields) {
                html += '<div class="notice">⚠️ Some details missing; estimate may be less precise.</div>';
            }
            
            html += `<pre>${JSON.stringify({ booking: test.booking, context: test.context }, null, 2)}</pre>`;
            
            testDiv.innerHTML = html;
            resultsContainer.appendChild(testDiv);
        });
    </script>
</body>
</html>
